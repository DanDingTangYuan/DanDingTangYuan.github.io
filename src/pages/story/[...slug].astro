---
/**
 * Story 單篇文章頁面 (story/[...slug].astro)
 * 
 * 用途：
 * - 顯示單篇 Story 小說/故事連載的完整內容
 * - 動態生成所有 Story 文章的頁面
 * - 使用 StoryPost 佈局提供統一的頁面風格
 * - 支援多語言路由
 * 
 * 路由：/story/[語言]/[文章-id]
 * 
 * 例如：
 * - /story/zh/my-novel-chapter-1
 * - /story/ja/fantasy-series-episode-5
 */

import { type CollectionEntry, getCollection, render } from 'astro:content';
import StoryPost from '../../layouts/StoryPost.astro';
import { SUPPORTED_LANGUAGES } from '../../i18n/config';

/**
 * 生成靜態路徑
 * Astro 會為每篇 Story 文章的每個語言版本生成一個靜態頁面
 */
export async function getStaticPaths() {
	// 獲取所有 Story 文章
	const posts = await getCollection('story');
	
	// 為每篇文章生成路由
	// 說明：
	// - 每個文章只生成一個路由
	// - 文章 ID 格式：'zh/my-post' 或 'ja/my-post'
	// - 路由會是 /story/zh/my-post 或 /story/ja/my-post
	// - 如果日文版本不存在，訪問 /story/ja/my-post 時會自動使用中文版本
	//   （這個 fallback 邏輯在 getStaticPaths 中實現）
	
	const paths = [];
	
	// 建立一個 Map 來存儲每個 slug 的所有語言版本
	const postsBySlug = new Map();
	
	for (const post of posts) {
		// 從文章 ID 中提取語言代碼
		// 例如：'zh/my-post' -> lang: 'zh', slug: 'my-post'
		const [lang, ...slugParts] = post.id.split('/');
		const slug = slugParts.join('/');
		
		// 驗證語言代碼是否有效
		if (SUPPORTED_LANGUAGES.includes(lang as any)) {
			if (!postsBySlug.has(slug)) {
				postsBySlug.set(slug, {});
			}
			postsBySlug.get(slug)[lang] = post;
		}
	}
	
	// 為每個 slug 生成路由
	// 邏輯：優先使用該語言的版本，如果不存在則使用中文版本
	for (const [slug, langPosts] of postsBySlug) {
		for (const lang of SUPPORTED_LANGUAGES) {
			// 如果該語言有文章，使用該文章
			// 否則 fallback 到中文
			const post = langPosts[lang] || langPosts['zh'];
			
			if (post) {
				paths.push({
					params: { slug: `${lang}/${slug}` }, // URL 參數：/story/zh/my-post 或 /story/ja/my-post
					props: post, // 傳遞給組件的 Props
				});
			}
		}
	}
	
	return paths;
}

/** Story 文章的類型定義 */
type Props = CollectionEntry<'story'>;

/** 
 * 獲取當前文章數據
 * Astro 會根據 URL 自動傳遞正確的文章
 */
const post = Astro.props;

/** 渲染文章內容為 HTML */
const { Content } = await render(post);
---

{/* 使用 StoryPost 佈局顯示文章 */}
<StoryPost {...post.data}>
	{/* 文章內容 */}
	<Content />
</StoryPost>
