---
/**
 * é¦–é  (index.astro)
 * 
 * ç”¨é€”ï¼š
 * - é¡¯ç¤ºç¶²ç«™é¦–é 
 * - å±•ç¤º Hero å€åŸŸå’Œå‹•ç•«æ•ˆæœ
 * - é¡¯ç¤ºæœ€è¿‘æ›´æ–°çš„æ–‡ç« å¡ç‰‡
 * - æ”¯æŒæ–‡ç« ç½®é ‚åŠŸèƒ½
 * 
 * åŠŸèƒ½ï¼š
 * - å¾æ‰€æœ‰å…§å®¹é›†åˆä¸­ç²å–æ–‡ç« 
 * - æŒ‰ç™¼å¸ƒæ—¥æœŸæ’åº
 * - åˆ†é›¢ç½®é ‚å’Œæ™®é€šæ–‡ç« 
 * - é™åˆ¶é¡¯ç¤ºæ•¸é‡ï¼ˆæœ€å¤š 12 ç¯‡ï¼‰
 */

import BaseHead from "../components/BaseHead.astro";
import Footer from "../components/Footer.astro";
import Header from "../components/Header.astro";
import FormattedDate from "../components/FormattedDate.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "../consts";
import { getCollection } from "astro:content";
import "../styles/index.css";

// åœ–ç‰‡å„ªåŒ–
import { getImage } from "astro:assets";
import myBackground from "../assets/hero_background.jpg";

/** å„ªåŒ–èƒŒæ™¯åœ–ç‰‡ç‚º WebP æ ¼å¼ä»¥æé«˜åŠ è¼‰é€Ÿåº¦ */
const optimizedBackground = await getImage({
  src: myBackground,
  format: "webp",
});

// ============================================================================
// å…§å®¹ç²å–å’Œè™•ç†
// ============================================================================

/** å¾å„å€‹å…§å®¹é›†åˆä¸­ç²å–æ–‡ç«  */
const blogPosts = await getCollection("blog");
const devlogPosts = await getCollection("devlog");
const storyPosts = await getCollection("story");

/** 
 * åˆä½µæ‰€æœ‰å…§å®¹ä¸¦æ·»åŠ é¡å‹æ¨™è¨˜
 * é€™æ¨£å¯ä»¥åœ¨æ¨¡æ¿ä¸­å€åˆ†ä¸åŒé¡å‹çš„æ–‡ç« 
 */
const allPosts = [
  ...blogPosts.map(post => ({ ...post, type: "blog" as const, url: `/blog/${post.id}` })),
  ...devlogPosts.map(post => ({ ...post, type: "devlog" as const, url: `/devlog/${post.id}` })),
  ...storyPosts.map(post => ({ ...post, type: "story" as const, url: `/story/${post.id}` }))
];

/** 
 * åˆ†é›¢ç½®é ‚æ–‡ç« 
 * ç½®é ‚æ–‡ç« æœƒé¡¯ç¤ºåœ¨æœ€å‰é¢
 * æœ€å¤šé¡¯ç¤º 2 ç¯‡ç½®é ‚æ–‡ç« 
 */
const pinnedPosts = allPosts
  .filter(post => post.data.pinned === true)
  .sort((a, b) => new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf())
  .slice(0, 2);

/** 
 * æ™®é€šæ–‡ç« 
 * æŒ‰ç™¼å¸ƒæ—¥æœŸé™åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
 * æ•¸é‡ = 12 - ç½®é ‚æ–‡ç« æ•¸é‡
 */
const regularPosts = allPosts
  .filter(post => post.data.pinned !== true)
  .sort((a, b) => new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf())
  .slice(0, 12 - pinnedPosts.length);

/** æœ€çµ‚é¡¯ç¤ºçš„æ–‡ç« åˆ—è¡¨ï¼ˆç½®é ‚åœ¨å‰ï¼Œæ™®é€šåœ¨å¾Œï¼‰ */
const displayPosts = [...pinnedPosts, ...regularPosts];
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
  </head>
  <body>
    <Header />

    <main>
      <section
        class="hero"
        style={`background-image: url(${optimizedBackground.src});`}
      >
        <a href="#hero-content-start" class="hero-card">
          <div id="hero-btn">
            <span class="blob blob-1"></span>
            <span class="blob blob-2"></span>
            <span class="blob blob-3"></span>
            <span class="blob blob-4"></span>

            <div class="text-content">
              <h1 class="title">è¨€ã®è‘‰ã®æ ã¸</h1>
              <h1 class="title">ã‚ˆã†ã“ã</h1>
            </div>
          </div>
        </a>
        <div class="hero-image">
          <!-- é€™è£¡æ”¾ä¸€å¼µåœ–ç‰‡æˆ–ç°¡å–®çš„è‰²å¡Šåœ–å½¢ -->
          <div class="placeholder-img"></div>
        </div>
      </section>

      <div class="dummy-content" id="hero-content-start">
        <h2 class="section-title">æœ€è¿‘æ›´æ–°</h2>
        <p class="section-subtitle">æ¢ç´¢æœ€æ–°çš„æ–‡ç« ã€é–‹ç™¼æ—¥èªŒå’Œæ•…äº‹</p>
        
        <div class="cards-grid">
          {displayPosts.map((post) => (
            <article class={`update-card ${post.data.pinned ? 'pinned-card' : ''}`}>
              {/* å¡ç‰‡å®¹å™¨ - ä¸å†æ˜¯é€£çµï¼Œåªæœ‰æŒ‰éˆ•æ˜¯é€£çµ */}
              <div class="card-link">
                {/* å…§å®¹å€åŸŸ - å·¦å´å½ˆæ€§å¯¬åº¦ */}
                <div class="card-main-content">
                  <div class="card-header">
                    <span class={`card-type card-type-${post.type}`}>
                      {post.type === 'blog' ? 'Blog' : 
                       post.type === 'devlog' ? 'DevLog' : 'Story'}
                    </span>
                    {post.data.pinned && (
                      <span class="pinned-badge">ğŸ“Œ ç½®é ‚</span>
                    )}
                  </div>
                  
                  <div class="card-content">
                    <h3 class="card-title">{post.data.title}</h3>
                    <p class="card-description">
                      {post.type === 'story' 
                        ? `${'series' in post.data ? post.data.series : ''} - ç¬¬ ${'chapter' in post.data ? post.data.chapter : ''} ç« `
                        : ('description' in post.data ? post.data.description : 'æš«ç„¡æè¿°')
                      }
                    </p>
                    
                    {post.data.tags && post.data.tags.length > 0 && (
                      <div class="card-tags">
                        {post.data.tags.slice(0, 3).map((tag) => (
                          <span class="tag">{tag}</span>
                        ))}
                      </div>
                    )}
                  </div>
                  
                  <div class="card-meta">
                    {/* æ—¥æœŸ - ç°è‰²æ¨™ç±¤æ¨£å¼ */}
                    <span class="card-date">
                      <FormattedDate date={post.data.pubDate} />
                    </span>
                    {/* é–±è®€æ›´å¤šæŒ‰éˆ• - å”¯ä¸€çš„å¯é»æ“Šå…ƒç´  */}
                    <a href={post.url} class="read-more">é–±è®€æ›´å¤š â†’</a>
                  </div>
                </div>
                
                {/* åœ–ç‰‡å€åŸŸ - å³å´å‹•æ…‹å¯¬åº¦ */}
                {(() => {
                  const thumbnail = 'thumbnail' in post.data ? post.data.thumbnail : undefined;
                  const coverImage = 'coverImage' in post.data ? post.data.coverImage : undefined;
                  const imageUrl = thumbnail || coverImage;
                  
                  /* å¦‚æœæœ‰åœ–ç‰‡å°±é¡¯ç¤ºï¼Œæ²’æœ‰å°±ä¸é¡¯ç¤ºä»»ä½•æ±è¥¿ */
                  return imageUrl ? (
                    <div class="card-image">
                      <img src={imageUrl} alt={post.data.title} />
                    </div>
                  ) : null;
                })()}
              </div>
            </article>
          ))}
        </div>
        
        <div class="view-all-links">
          <a href="/blog" class="view-all-btn">æŸ¥çœ‹æ‰€æœ‰ Blog</a>
          <a href="/devlog" class="view-all-btn">æŸ¥çœ‹æ‰€æœ‰ DevLog</a>
          <a href="/story" class="view-all-btn">æŸ¥çœ‹æ‰€æœ‰ Story</a>
        </div>
      </div>
    </main>
    <Footer />
  </body>
</html>

<script>
  // 1. æŠ“å– Header å’Œ Hero å…ƒç´ 
  const header = document.querySelector("header");
  const hero = document.querySelector(".hero");

  // 2. è¨˜éŒ„ã€Œä¸Šä¸€æ¬¡ã€çš„æ»¾å‹•ä½ç½®ï¼Œé è¨­ç‚º 0
  let lastScrollY = window.scrollY;

  // ç¢ºä¿å…ƒç´ éƒ½å­˜åœ¨æ‰åŸ·è¡Œ
  if (header && hero) {
    window.addEventListener("scroll", () => {
      const currentScrollY = window.scrollY;
      // @ts-ignore
      const heroHeight = hero.offsetHeight; // æŠ“å– Hero å€å¡Šçš„é«˜åº¦

      // --- é‚è¼¯ 1ï¼šæ§åˆ¶é¡¯ç¤º/éš±è— (ä¾æ“šæ–¹å‘) ---
      // åªæœ‰ç•¶æ»¾å‹•è¶…éä¸€é»é» (50px) å¾Œæ‰é–‹å§‹åšæ”¶åˆå‹•ä½œï¼Œé¿å…åœ¨é ‚éƒ¨å¾®èª¿æ™‚ä¸€ç›´é–ƒ
      if (currentScrollY > lastScrollY && currentScrollY > 50) {
        // å‘ä¸‹æ»¾ -> éš±è—
        header.classList.add("nav-hidden");
      } else {
        // å‘ä¸Šæ»¾ -> é¡¯ç¤º
        header.classList.remove("nav-hidden");
      }

      // --- é‚è¼¯ 2ï¼šæ§åˆ¶é¡è‰²/é€æ˜åº¦ (ä¾æ“šä½ç½®) ---
      // å¦‚æœæ»¾å‹•è·é›¢ è¶…é Hero çš„é«˜åº¦ (æ¸›å»ä¸€é»ç·©è¡ï¼Œä¾‹å¦‚ Header è‡ªèº«é«˜åº¦ï¼Œè¦–è¦ºæ¯”è¼ƒé †)
      if (currentScrollY > heroHeight - 80) {
        // é›¢é–‹ Hero -> è®Šæˆå¯¦è‰²
        header.classList.add("nav-solid");
      } else {
        // é‚„åœ¨ Hero å…§ -> ç§»é™¤å¯¦è‰² (è®Šå› CSS é è¨­çš„åŠé€æ˜)
        header.classList.remove("nav-solid");
      }

      // æ›´æ–°æœ€å¾Œæ»¾å‹•ä½ç½®
      lastScrollY = currentScrollY;
    });
  }


</script>

<style>
  /* ç‚ºäº†è®“æ»‘å‹•åœä¸‹ä¾†çš„ä½ç½®å‰›å¥½é¿é–‹ Header (å¦‚æœ header æœƒæ“‹ä½æ¨™é¡Œçš„è©±) */
  #content-start {
    scroll-margin-top: 80px; /* å‡è¨­ä½ çš„ Header é«˜åº¦æ˜¯ 80px */
  }

  #content-start h1 {
    font-size: 2.5rem;
    margin: 0 0 0.5rem 0;
    color: #2c3e50;
  }
</style>
